{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _defineProperty from \"@babel/runtime/helpers/defineProperty\";\nimport _objectWithoutProperties from \"@babel/runtime/helpers/objectWithoutProperties\";\n\nvar _marked = /*#__PURE__*/_regeneratorRuntime.mark(apiCaller);\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nimport { getAuthorizationHeader, getAuthToken, setAuthToken, removeAuthToken } from '../utils';\nimport { call, put } from 'redux-saga/effects';\nimport authAgent from '../app/auth-agent';\nimport { ACCESS_TOKEN_FAILURE } from '../../actions/auth';\nexport default function apiCaller(request, _ref) {\n  var _ref$headers, headers, rest, token, authorizeHeader, props, response, refreshedToken;\n\n  return _regeneratorRuntime.wrap(function apiCaller$(_context) {\n    while (1) {\n      switch (_context.prev = _context.next) {\n        case 0:\n          _ref$headers = _ref.headers, headers = _ref$headers === void 0 ? {} : _ref$headers, rest = _objectWithoutProperties(_ref, [\"headers\"]);\n          _context.next = 3;\n          return call(getAuthToken);\n\n        case 3:\n          token = _context.sent;\n          _context.next = 6;\n          return call(getAuthorizationHeader, token.access_token);\n\n        case 6:\n          authorizeHeader = _context.sent;\n          props = _objectSpread(_objectSpread({}, rest), {}, {\n            headers: _objectSpread(_objectSpread(_objectSpread({}, headers), authorizeHeader), {}, {\n              token: token.access_token\n            })\n          });\n          _context.prev = 8;\n          _context.next = 11;\n          return call(request, props);\n\n        case 11:\n          response = _context.sent;\n          return _context.abrupt(\"return\", response || {});\n\n        case 15:\n          _context.prev = 15;\n          _context.t0 = _context[\"catch\"](8);\n\n          if (!(_context.t0.status === 401)) {\n            _context.next = 42;\n            break;\n          }\n\n          _context.prev = 18;\n          _context.next = 21;\n          return call(authAgent.Auth.refreshAccessToken, token.refresh_token);\n\n        case 21:\n          refreshedToken = _context.sent;\n\n          if (!refreshedToken) {\n            _context.next = 28;\n            break;\n          }\n\n          _context.next = 25;\n          return call(setAuthToken, refreshedToken.data);\n\n        case 25:\n          _context.next = 27;\n          return call(apiCaller, request, props);\n\n        case 27:\n          return _context.abrupt(\"return\", _context.sent);\n\n        case 28:\n          _context.next = 40;\n          break;\n\n        case 30:\n          _context.prev = 30;\n          _context.t1 = _context[\"catch\"](18);\n\n          if (!(_context.t1.status === 400)) {\n            _context.next = 39;\n            break;\n          }\n\n          _context.next = 35;\n          return call(removeAuthToken);\n\n        case 35:\n          _context.next = 37;\n          return put({\n            type: ACCESS_TOKEN_FAILURE,\n            payload: _context.t1.message\n          });\n\n        case 37:\n          _context.next = 40;\n          break;\n\n        case 39:\n          throw _context.t1;\n\n        case 40:\n          _context.next = 43;\n          break;\n\n        case 42:\n          throw _context.t0;\n\n        case 43:\n        case \"end\":\n          return _context.stop();\n      }\n    }\n  }, _marked, null, [[8, 15], [18, 30]]);\n}","map":{"version":3,"sources":["/Users/mkeffele/git_repos/website/docudio/sagas/api/api-caller.js"],"names":["apiCaller","getAuthorizationHeader","getAuthToken","setAuthToken","removeAuthToken","call","put","authAgent","ACCESS_TOKEN_FAILURE","request","headers","rest","token","access_token","authorizeHeader","props","response","status","Auth","refreshAccessToken","refresh_token","refreshedToken","data","type","payload","message"],"mappings":";;;;oDAK0BA,S;;;;;;AAL1B,SAASC,sBAAT,EAAiCC,YAAjC,EAA+CC,YAA/C,EAA6DC,eAA7D,QAAoF,UAApF;AACA,SAASC,IAAT,EAAeC,GAAf,QAA0B,oBAA1B;AACA,OAAOC,SAAP,MAAsB,mBAAtB;AACA,SAASC,oBAAT,QAAqC,oBAArC;AAEA,eAAe,SAAWR,SAAX,CAAsBS,OAAtB;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,8BACbC,OADa,EACbA,OADa,6BACH,EADG,iBAEVC,IAFU;AAAA;AAIC,iBAAMN,IAAI,CAACH,YAAD,CAAV;;AAJD;AAIPU,UAAAA,KAJO;AAAA;AAKW,iBAAMP,IAAI,CAACJ,sBAAD,EAAyBW,KAAK,CAACC,YAA/B,CAAV;;AALX;AAKPC,UAAAA,eALO;AAMPC,UAAAA,KANO,mCAORJ,IAPQ;AAQXD,YAAAA,OAAO,gDACFA,OADE,GAEFI,eAFE;AAGLF,cAAAA,KAAK,EAAEA,KAAK,CAACC;AAHR;AARI;AAAA;AAAA;AAgBM,iBAAMR,IAAI,CAACI,OAAD,EAAUM,KAAV,CAAV;;AAhBN;AAgBLC,UAAAA,QAhBK;AAAA,2CAiBJA,QAAQ,IAAI,EAjBR;;AAAA;AAAA;AAAA;;AAAA,gBAmBP,YAAEC,MAAF,KAAa,GAnBN;AAAA;AAAA;AAAA;;AAAA;AAAA;AAqBgB,iBAAMZ,IAAI,CAACE,SAAS,CAACW,IAAV,CAAeC,kBAAhB,EAAoCP,KAAK,CAACQ,aAA1C,CAAV;;AArBhB;AAqBDC,UAAAA,cArBC;;AAAA,eAsBHA,cAtBG;AAAA;AAAA;AAAA;;AAAA;AAuBL,iBAAMhB,IAAI,CAACF,YAAD,EAAekB,cAAc,CAACC,IAA9B,CAAV;;AAvBK;AAAA;AAwBE,iBAAMjB,IAAI,CAACL,SAAD,EAAYS,OAAZ,EAAqBM,KAArB,CAAV;;AAxBF;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA,gBA2BH,YAAaE,MAAb,KAAwB,GA3BrB;AAAA;AAAA;AAAA;;AAAA;AA4BL,iBAAMZ,IAAI,CAACD,eAAD,CAAV;;AA5BK;AAAA;AA6BL,iBAAME,GAAG,CAAC;AAAEiB,YAAAA,IAAI,EAAEf,oBAAR;AAA8BgB,YAAAA,OAAO,EAAE,YAAaC;AAApD,WAAD,CAAT;;AA7BK;AAAA;AAAA;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA","sourcesContent":["import { getAuthorizationHeader, getAuthToken, setAuthToken, removeAuthToken } from '../utils'\nimport { call, put } from 'redux-saga/effects'\nimport authAgent from '../app/auth-agent'\nimport { ACCESS_TOKEN_FAILURE } from '../../actions/auth'\n\nexport default function * apiCaller (request, {\n  headers = {},\n  ...rest\n}) {\n  const token = yield call(getAuthToken)\n  const authorizeHeader = yield call(getAuthorizationHeader, token.access_token)\n  const props = {\n    ...rest,\n    headers: {\n      ...headers,\n      ...authorizeHeader,\n      token: token.access_token\n    }\n  }\n\n  try {\n    const response = yield call(request, props)\n    return response || {}\n  } catch (e) {\n    if (e.status === 401) {\n      try {\n        const refreshedToken = yield call(authAgent.Auth.refreshAccessToken, token.refresh_token)\n        if (refreshedToken) {\n          yield call(setAuthToken, refreshedToken.data)\n          return yield call(apiCaller, request, props)\n        }\n      } catch (refreshError) {\n        if (refreshError.status === 400) {\n          yield call(removeAuthToken)\n          yield put({ type: ACCESS_TOKEN_FAILURE, payload: refreshError.message })\n        } else {\n          throw refreshError\n        }\n      }\n    } else {\n      throw e\n    }\n  }\n}\n"]},"metadata":{},"sourceType":"module"}